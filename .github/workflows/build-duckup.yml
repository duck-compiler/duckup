name: build-duckup-nightly

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  CARGO_TERM_COLOR: always

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      channel: ${{ steps.get_version.outputs.channel }}
    steps:
    - name: checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: extract version and channel
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
          CHANNEL="stable"
        else
          # For nightly builds, use date + short commit hash
          DATE=$(date +%Y%m%d)
          SHORT_SHA=${GITHUB_SHA:0:7}
          VERSION="${DATE}-${SHORT_SHA}"
          CHANNEL="nightly"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
        echo "release version: $VERSION (channel: $CHANNEL)"

  build-linux-x86_64:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: install rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        components: rustfmt, clippy

    - name: clean cargo cache and update toolchain
      run: |
        cargo clean
        rustup update

    - name: cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: build for linux (x86_64)
      run: cargo build --release --bin duckup --target x86_64-unknown-linux-gnu

    - name: upload linux x86_64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-x86_64
        path: target/x86_64-unknown-linux-gnu/release/duckup

  build-linux-aarch64:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: install rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        components: rustfmt, clippy

    - name: clean cargo cache and update toolchain
      run: |
        cargo clean
        rustup update

    - name: install cross-compilation toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu
        rustup target add aarch64-unknown-linux-gnu

    - name: cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: build for linux (arm64)
      run: |
        export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
        export CXX_aarch64_unknown_linux_gnu=aarch64-linux-gnu-g++
        export AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar
        export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc

        cargo build --release --bin duckup --target aarch64-unknown-linux-gnu

    - name: upload linux arm64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-aarch64
        path: target/aarch64-unknown-linux-gnu/release/duckup

  build-linux-armv7:
    runs-on: ubuntu-latest
    needs: setup
    steps:
    - name: checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: install rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        components: rustfmt, clippy

    - name: clean cargo cache and update toolchain
      run: |
        cargo clean
        rustup update

    - name: install cross-compilation toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-linux-gnueabihf
        rustup target add armv7-unknown-linux-gnueabihf

    - name: cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: build for linux (ARMv7)
      run: |
        export CC_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-gcc
        export CXX_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-g++
        export AR_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-ar
        export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER=arm-linux-gnueabihf-gcc
        cargo build --release --bin duckup --target armv7-unknown-linux-gnueabihf

    - name: upload Linux ARMv7 artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux-armv7
        path: target/armv7-unknown-linux-gnueabihf/release/duckup

  build-macos-x86_64:
    runs-on: macos-15
    needs: setup
    steps:
    - name: checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: install rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        components: rustfmt, clippy

    - name: clean cargo cache and update toolchain
      run: |
        cargo clean
        rustup update

    - name: cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: build for macOS (x86_64) - native
      run: cargo build --release --bin duckup

    - name: Upload macOS x86_64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-x86_64
        path: target/release/duckup

  build-macos-aarch64:
    runs-on: macos-15
    needs: setup
    steps:
    - name: checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: install rust toolchain
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        components: rustfmt, clippy

    - name: clean cargo cache and update toolchain
      run: |
        cargo clean
        rustup update

    - name: cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: build for macOS (arm64) - native
      run: cargo build --release --bin duckup

    - name: upload macOS arm64 artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-aarch64
        path: target/release/duckup

  build-windows:
    runs-on: windows-2025
    needs: setup
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: install rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        components: rustfmt, clippy

    - name: clean cargo cache and update toolchain
      run: |
        cargo clean
        rustup update

    - name: cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: build for Windows (x86_64)
      run: cargo build --release --bin duckup --target x86_64-pc-windows-msvc

    - name: upload windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-x86_64
        path: target/x86_64-pc-windows-msvc/release/duckup.exe

  # Create nightly release
  create-nightly-release:
    needs: [setup, build-linux-x86_64, build-linux-aarch64, build-linux-armv7, build-macos-x86_64, build-macos-aarch64, build-windows]
    runs-on: ubuntu-latest
    if: ${{ needs.setup.outputs.channel == 'nightly' }}
    permissions:
      contents: write
      packages: write
    steps:
    - name: checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: prepare nightly release assets
      run: |
        mkdir -p nightly-assets

        # Copy Linux binaries
        cp artifacts/linux-x86_64/duckup nightly-assets/duckup-linux-x86_64
        chmod +x nightly-assets/duckup-linux-x86_64

        cp artifacts/linux-aarch64/duckup nightly-assets/duckup-linux-aarch64
        chmod +x nightly-assets/duckup-linux-aarch64

        cp artifacts/linux-armv7/duckup nightly-assets/duckup-linux-armv7
        chmod +x nightly-assets/duckup-linux-armv7

        # Copy macOS binaries
        cp artifacts/macos-x86_64/duckup nightly-assets/duckup-macos-x86_64
        chmod +x nightly-assets/duckup-macos-x86_64

        cp artifacts/macos-aarch64/duckup nightly-assets/duckup-macos-aarch64
        chmod +x nightly-assets/duckup-macos-aarch64

        # Copy Windows binary
        cp artifacts/windows-x86_64/duckup.exe nightly-assets/duckup-windows-x86_64.exe

    - name: create checksums
      run: |
        cd nightly-assets
        for file in *; do
          sha256sum "$file" > "${file}.sha256"
        done
        cd ..

    - name: create nightly archive
      run: |
        cd nightly-assets
        tar -czf ../duckup-${{ needs.setup.outputs.version }}-nightly.tar.gz *
        cd ..

    - name: create nightly release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly-${{ needs.setup.outputs.version }}
        name: Duckup Nightly ${{ needs.setup.outputs.version }}
        body: |
          ## Duckup Nightly Build ${{ needs.setup.outputs.version }}
          ⚠️ **Warning**: This is a nightly build of the **duckup toolchain manager**.

          ### ⚡ Quick Install (Linux & macOS)

          Copy and paste this into your terminal to install this nightly version:
          ```bash
          os=$(uname -s | tr '[:upper:]' '[:lower:]'); [ "$os" = "darwin" ] && os="macos"; curl -fsSL [https://github.com/$](https://github.com/$){{ github.repository }}/releases/download/nightly-${{ needs.setup.outputs.version }}/duckup-$os-$(uname -m) -o duckup && chmod +x duckup && ./duckup update
          ```

          ### Manual Downloads

          **Linux:**
          - [duckup-linux-x86_64](https://github.com/${{ github.repository }}/releases/download/nightly-${{ needs.setup.outputs.version }}/duckup-linux-x86_64)
          - [duckup-linux-aarch64](https://github.com/${{ github.repository }}/releases/download/nightly-${{ needs.setup.outputs.version }}/duckup-linux-aarch64)
          - [duckup-linux-armv7](https://github.com/${{ github.repository }}/releases/download/nightly-${{ needs.setup.outputs.version }}/duckup-linux-armv7)

          **macOS:**
          - [duckup-macos-x86_64](https://github.com/${{ github.repository }}/releases/download/nightly-${{ needs.setup.outputs.version }}/duckup-macos-x86_64)
          - [duckup-macos-aarch64](https://github.com/${{ github.repository }}/releases/download/nightly-${{ needs.setup.outputs.version }}/duckup-macos-aarch64)

          **Windows:**
          - [duckup-windows-x86_64.exe](https://github.com/${{ github.repository }}/releases/download/nightly-${{ needs.setup.outputs.version }}/duckup-windows-x86_64.exe)

          **All platforms:**
          - [duckup-${{ needs.setup.outputs.version }}-nightly.tar.gz](https://github.com/${{ github.repository }}/releases/download/nightly-${{ needs.setup.outputs.version }}/duckup-${{ needs.setup.outputs.version }}-nightly.tar.gz)

        files: |
          nightly-assets/*
          duckup-${{ needs.setup.outputs.version }}-nightly.tar.gz
        draft: false
        prerelease: true
